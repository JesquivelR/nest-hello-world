version: 0.2

env:
  variables:
    REPOSITORY_URI: "181230042822.dkr.ecr.us-east-1.amazonaws.com/nest-hello-world"
    ENV: "prod"
    PROJECT: "pruebas"
    APPLICATION: "nest-hello-world"
    SONAR_TOKEN: "d9af1d73e3713b008a813830a7e091cd40df2950"
    NVD_API_key: "ed5ecefa-22d4-4af1-8a89-9739e0ac607f"
    DC_VERSION: "12.1.1"
    SONAR_SCANNER_VERSION: "7.1.0.4889"
    DEPENDENCY_CHECK_DIR: "/opt/dependency-check"
    SONAR_SCANNER_DIR: "/opt/sonar-scanner"

phases:
  install:
    runtime-versions:
      java: corretto17
      nodejs: 18
    commands:
      - echo "=== Fase de instalación ==="
      
      # Instalación condicional de SonarScanner
      - if [ ! -d "$SONAR_SCANNER_DIR" ]; then
          echo "Instalando SonarScanner v$SONAR_SCANNER_VERSION";
          wget -q "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux-x64.zip" -O /tmp/sonar-scanner.zip;
          unzip -q /tmp/sonar-scanner.zip -d /opt/;
          mv /opt/sonar-scanner-* $SONAR_SCANNER_DIR;
          chmod +x $SONAR_SCANNER_DIR/bin/sonar-scanner;
          ln -s $SONAR_SCANNER_DIR/bin/sonar-scanner /usr/local/bin/;
        else
          echo "SonarScanner ya instalado. Saltando descarga.";
        fi

      # Instalación condicional de Dependency-Check
      - if [ ! -d "$DEPENDENCY_CHECK_DIR" ]; then
          echo "Instalando Dependency-Check v${DC_VERSION}";
          wget -q "https://github.com/dependency-check/DependencyCheck/releases/download/v${DC_VERSION}/dependency-check-${DC_VERSION}-release.zip" -O /tmp/dependency-check.zip;
          unzip -q /tmp/dependency-check.zip -d /opt/;
          chmod +x $DEPENDENCY_CHECK_DIR/bin/dependency-check.sh;
          ln -s $DEPENDENCY_CHECK_DIR/bin/dependency-check.sh /usr/local/bin/dependency-check;
        else
          echo "Dependency-Check ya instalado. Saltando descarga.";
        fi

      # Verificación de herramientas
      - echo "Versiones de herramientas:"
      - node --version
      - npm --version
      - sonar-scanner -v
      - dependency-check --version

  pre_build:
    commands:
      - echo "=== Pre-Build ==="
      
      # Login a ECR
      - aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | docker login --username AWS --password-stdin ${REPOSITORY_URI%/*}
      
      # Metadata para despliegues
      - export COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c1-7)
      - export IMAGE_TAG=${ENV}-${APPLICATION}-${COMMIT_HASH}-${CODEBUILD_BUILD_NUMBER}
      - export IMAGE_URI=$REPOSITORY_URI:$IMAGE_TAG
      
      # Instalación de dependencias con caché
      - echo "Instalando dependencias de Node.js..."
      - npm ci --cache .npm --prefer-offline

  build:
    commands:
      - echo "=== Build ==="
      
      # 1. Análisis de vulnerabilidades con Dependency-Check
      - echo "Ejecutando Dependency-Check..."
      - mkdir -p reports/dependency-check
      - >
        dependency-check 
        --project "$APPLICATION" 
        --scan "package-lock.json" 
        --scan "src" 
        --format HTML 
        --out reports/dependency-check 
        --enableExperimental 
        --nvdApiKey "$NVD_API_key" 
        --failOnCVSS 7 
        --suppression dependency-check-suppressions.xml 
        || echo "##[warning] Dependency-Check encontró vulnerabilidades"
      
      # 2. Análisis de código con SonarQube
      - echo "Ejecutando SonarScanner..."
      - CURRENT_BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD | sed "s/[^a-zA-Z0-9]/_/g")
      - sonar-scanner -Dsonar.token=$SONAR_TOKEN -Dsonar.branch.name=$CURRENT_BRANCH_NAME
      
      # 3. Construcción de imagen Docker
      - echo "Construyendo imagen Docker..."
      - docker build --cache-from $REPOSITORY_URI:latest -t $IMAGE_URI -t $REPOSITORY_URI:latest .

  post_build:
    commands:
      - echo "=== Post-Build ==="
      
      # 1. Push de imagen Docker
      - docker push $IMAGE_URI
      - docker push $REPOSITORY_URI:latest
      
      # 2. Preparación de artefactos - CORRECCIÓN DEL ERROR
      - mkdir -p artefactos/dependency-check
      - mkdir -p artefactos/ecs
      
      # Copiar solo si existen archivos (evitar error con wildcard)
      - if [ -n "$(ls -A reports/dependency-check/)" ]; then
          cp -r reports/dependency-check/* artefactos/dependency-check/;
        else
          echo "No se encontraron reportes de Dependency-Check para copiar";
        fi
      
      - printf '[{"name":"%s","imageUri":"%s"}]' "$APPLICATION" "$IMAGE_URI" > artefactos/ecs/imagedefinitions.json
      - echo "Estructura de artefactos:"
      - tree artefactos || true

artifacts:
  files:
    - 'artefactos/**/*'
  base-directory: 'artefactos'

cache:
  paths:
    - '/root/.sonar/cache/**/*'
    - '$DEPENDENCY_CHECK_DIR/data/**/*'
    - '/root/.npm/**/*'
    - '.npm/**/*'